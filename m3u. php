<?php
// m3u.php - الكود المصحح لجلب التوكن وتاريخ الانتهاء

// تفعيل عرض الأخطاء (للتجريب فقط)
// error_reporting(E_ALL);
// ini_set('display_errors', 1);

require_once 'config.php';

$username = $_GET['username'] ?? '';
$token = $_GET['password'] ?? ''; // نستخدم 'password' كما يطلب التطبيق

if (empty($username) || empty($token)) {
    // إذا لم يتم توفير البيانات، قم بالخروج أو عرض خطأ بصيغة نصية واضحة
    header('Content-Type: text/plain');
    die("خطأ: يرجى توفير اسم المستخدم وكلمة المرور (التوكن).");
}

try {
    // 1. التحقق من المشترك وتاريخ الانتهاء
    $stmt = $db->prepare("SELECT id, status, expiry_date FROM subscribers WHERE username = ? AND token = ?");
    $stmt->execute([$username, $token]);
    $subscriber = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$subscriber) {
        header('Content-Type: text/plain');
        die("خطأ: بيانات الدخول غير صحيحة.");
    }

    // التحقق من تاريخ الانتهاء
    $now = time();
    $expiry_timestamp = strtotime($subscriber['expiry_date']);

    if ($expiry_timestamp < $now) {
        header('Content-Type: text/plain');
        die("خطأ: انتهت صلاحية اشتراكك بتاريخ: " . $subscriber['expiry_date']);
    }

    // 2. إذا كان المشترك صالحًا، قم بجلب القنوات
    $stmt_channels = $db->prepare("SELECT name, url, category FROM channels WHERE enabled = 1 ORDER BY category, name");
    $stmt_channels->execute();
    $channels = $stmt_channels->fetchAll(PDO::FETCH_ASSOC);

    // 3. إرسال ترويسة M3U وبدء الإخراج
    header('Content-Type: application/vnd.apple.mpegurl'); // الترويسة الصحيحة لـ M3U
    header('Content-Disposition: attachment; filename="playlist.m3u"');

    echo "#EXTM3U\n";

    if (empty($channels)) {
        echo "#EXTINF:-1, لا توجد قنوات متاحة حاليًا\n";
    } else {
        foreach ($channels as $channel) {
            $name = $channel['name'];
            $url = $channel['url'];
            $category = $channel['category'] ?? 'عام';

            // سطر معلومات القناة
            echo "#EXTINF:-1 group-title=\"{$category}\",{$name}\n";
            // سطر رابط القناة
            echo "{$url}\n";
        }
    }

} catch (PDOException $e) {
    header('Content-Type: text/plain');
    die("خطأ قاعدة بيانات: " . $e->getMessage());
}
?>
